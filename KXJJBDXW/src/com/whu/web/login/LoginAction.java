/*
 * Generated by MyEclipse Struts
 * Template path: templates/java/JavaClass.vtl
 */
package com.whu.web.login;

import java.io.IOException;
import java.util.ArrayList;
import java.util.HashSet;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;
import org.apache.struts.actions.DispatchAction;

import com.whu.tools.DBTools;
import com.whu.tools.XmlTools;
import com.whu.web.eventmanage.ItemAndNum;
import com.whu.web.user.ModuleBean;
import com.whu.web.user.UserBean;
import com.whu.web.wsjb.WsjbDBTools;

/** 
 * MyEclipse Struts
 * Creation date: 06-14-2013
 * 
 * XDoclet definition:
 * @struts.action input="/login.jsp" validate="true"
 */
public class LoginAction extends DispatchAction {
	/*
	 * Generated Methods
	 */
	
	public ActionForward login(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws IOException {
		response.setContentType("text/html;charset=utf-8");
		request.setCharacterEncoding("utf-8");
		LoginForm loginForm = (LoginForm)form;

		String roleIDs = (String)request.getSession().getAttribute("RoleIDs");
		DBTools dbTools = new DBTools();
		ArrayList moduleList = new ArrayList();
		String sql = "";
		if(roleIDs!=null && !roleIDs.equals(""))
		{
			StringBuilder sqlBuilder= new StringBuilder("select MODULEIDS from SYS_ROLE where ID in(");
			String[] roleArray = roleIDs.split(",");
			for (int i = 0, len= roleArray.length; i < len; i++) {
				sqlBuilder.append(" ?,");
				if(i == len - 1) sqlBuilder.replace(sqlBuilder.length() - 1, sqlBuilder.length(), ")");
			}
			sql = sqlBuilder.toString();
			moduleList = dbTools.queryModuleFormRole(sql, roleArray);//根据角色编号，查询对应的功能模块
		}
		
		//取出多个角色重叠的功能模块
		HashSet h = new HashSet(moduleList);  
		moduleList.clear(); 
		moduleList.addAll(h);
		
		ModuleBean mb = GetModuleBean(moduleList);
		ArrayList result = new ArrayList();
		result.add(mb);
		loginForm.setRecordList(result);
		
		String jdChartXml = getJDChartXml();
		request.setAttribute("jdChartXml", jdChartXml);
		
		//查询最新接收到的网上举报信息，查询前5位
		WsjbDBTools db = new WsjbDBTools();
		sql = "select a.ID,a.REPORTID,a.REPORTNAME,a.BEREPORTNAME,a.BEDEPT,a.TIME from TB_REPORTINFO a where a.ISRECV = '0' order by ID desc limit 5";
		ArrayList wsjbList = new ArrayList();
		wsjbList = db.queryWsjbList(sql, new String[0]);
		loginForm.setWsjbList(wsjbList);
		
		//查询最新的反馈消息，包括专家鉴定意见和单位调查结果
		sql = "select * from TB_FKRECODER order by ID desc limit 5";
		ArrayList replyList = new ArrayList();
		replyList = dbTools.queryReplyList(sql, new String[0]);
		loginForm.setReplyList(replyList);
		
		//查询待办事项列表
		String userName = (String)request.getSession().getAttribute("UserName");
		sql = "select * from TB_MSGNOTIFY where (RECVNAME=? or AGENTOFFICER=?) and ISHANDLE='0' limit 5";
		ArrayList dbsxList = new ArrayList();
		dbsxList = dbTools.queryMsgNotify(sql, "1", new String[]{userName,userName});
		loginForm.setDbsxList(dbsxList);
		
		return mapping.findForward("success");
	}
	/**
	 * 得到各个阶段的统计显示数据
	 * @return
	 */
	public String getJDChartXml()
	{
		String result = "";
		String xAxisName = "阶段";
		String yAxisName = "个数";
		String numberPrefix = "";

		String sql = "select count(*) as NUM, substring(STATUS,1,1) as TITLE from TB_REPORTINFO where ISDELETE='0' and substring(STATUS,1,1) in ('1','2','3') group by substring(STATUS,1,1)";
		DBTools dbTools = new DBTools();
		ArrayList itemList = dbTools.queryTjInfo(sql, new String[0]);
		ItemAndNum ian;
		if(itemList.size() != 3)
		{
			for(int i = 0; i < itemList.size(); i++)
			{
				ian = (ItemAndNum)itemList.get(i);
				
			}
		}
		XmlTools xmlTool = new XmlTools();
		result = xmlTool.CreateXml("事件阶段统计", xAxisName, yAxisName, numberPrefix, itemList, "1");
		return result;
	}
	/**
	 * 根据功能模块列表生成功能bean
	 * @param moduleList
	 * @return
	 */
	public ModuleBean GetModuleBean(ArrayList moduleList)
	{
		ModuleBean mb = new ModuleBean();
		String id = "";
		for(int i = 0; i < moduleList.size(); i++)
		{	
			id = (String) moduleList.get(i);
			if(id.equals("1000000"))
			{
				mb.setGrbg("1");
			}
			else if(id.equals("1000100"))
			{
				mb.setWsjb("1");
			}
			else if(id.equals("1000200"))
			{
				mb.setSjlr("1");
			}
			else if(id.equals("1000400"))
			{
				mb.setSjgl("1");
			}
			else if(id.equals("1000401"))
			{
				mb.setSljd("1");
			}
			else if(id.equals("1000402"))
			{
				mb.setSjsp("1");
			}
			else if(id.equals("1000403"))
			{
				mb.setLadcjd("1");
			}
			else if(id.equals("1000404"))
			{
				mb.setCljd("1");
			}
			else if(id.equals("1000405"))
			{
				mb.setQbsj("1");
			}
			else if(id.equals("1000406"))
			{
				mb.setYscsj("1");
			}
			else if(id.equals("1000500"))
			{
				mb.setHygl("1");
			}
			else if(id.equals("1000600"))
			{
				mb.setSjtj("1");
			}
			else if(id.equals("2000000"))
			{
				mb.setYhzzgl("1");
			}
			else if(id.equals("2000100"))
			{
				mb.setZzgl("1");
			}
			else if(id.equals("2000200"))
			{
				mb.setGwgl("1");
			}
			else if(id.equals("2000300"))
			{
				mb.setYhgl("1");
			}
			else if(id.equals("2000400"))
			{
				mb.setJsgl("1");
			}
			else if(id.equals("3000000"))
			{
				mb.setXtgl("1");
			}
			else if(id.equals("3000100"))
			{
				mb.setSjzd("1");
			}
			else if(id.equals("3000200"))
			{
				mb.setXtfj("1");
			}
			else if(id.equals("3000300"))
			{
				mb.setXtrz("1");
			}
			else if(id.equals("3000400"))
			{
				mb.setMygl("1");
			}
			else if(id.equals("1000700"))
			{
				mb.setYjgl("1");
			}
			else if(id.equals("1000701"))
			{
				mb.setFsyj("1");
			}
			else if(id.equals("1000702"))
			{
				mb.setYxpzgl("1");
			}
			else if(id.equals("2000500"))
			{
				mb.setZjgl("1");
			}
			else if(id.equals("2000600"))
			{
				mb.setWygl("1");
			}
			else if(id.equals("4000000"))
			{
				mb.setJdzj("1");
				mb.setUserType("1");
			}
			else if(id.equals("4000100"))
			{
				mb.setZjxx("1");
			}
			else if(id.equals("4000200"))
			{
				mb.setAjjd("1");
			}
			else if(id.equals("5000000"))
			{
				mb.setYtdw("1");
				mb.setUserType("2");
			}
			else if(id.equals("5000100"))
			{
				mb.setAjdc("1");
			}
			else if(id.equals("1000703"))
			{
				mb.setTxl("1");
			}
			// begin test for creditManage Module
			else if(id.equals("6000000"))
				mb.setCredit("1");
			else if(id.equals("6000100"))
				mb.setMiscount("1");
			else if(id.equals("6000300"))
				mb.setInstitute("1");
			else if(id.equals("6000200"))
				mb.setReasearcher("1");
			else if(id.equals("6000400"))
				mb.setMistype("1");
			else if(id.equals("6000500"))
				mb.setPunish("1");
			//end 
			
			// faculty FK Module
			else if(id.equals("7000000")){
				mb.setFaculty("1");
				mb.setUserType("3");
			}
			else if(id.equals("7000100"))
				mb.setXbyj("1");
			else if(id.equals("1000800"))
				mb.setWdlzj("1");
			else if(id.equals("1000900"))
				mb.setEd("1");
			
		}
		return mb;
	}
}